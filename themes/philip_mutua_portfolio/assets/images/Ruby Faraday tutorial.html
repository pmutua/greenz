<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Ruby Faraday tutorial</title>
<link rel="stylesheet" href="Ruby%20Faraday%20tutorial_files/format2.css" type="text/css">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="keywords" content="Ruby, Faraday, www, HTTP client, API, HTTP request, HTTP response, Sinatra">
<meta name="description" content="This tutorial introduces the Ruby Faraday module. We grab data, post
data, work with JSON, and connect to a secure web page. We also create a custom Faraday middleware.">
<meta name="author" content="Jan Bodnar">

<script src="Ruby%20Faraday%20tutorial_files/ca-pub-9706709751191532.js"></script><script src="Ruby%20Faraday%20tutorial_files/cbgapi.loaded_1" async=""></script><script src="Ruby%20Faraday%20tutorial_files/cbgapi.loaded_0" async=""></script><script id="facebook-jssdk" src="Ruby%20Faraday%20tutorial_files/sdk.js"></script><script id="twitter-wjs" src="Ruby%20Faraday%20tutorial_files/widgets.js"></script><script async="" src="Ruby%20Faraday%20tutorial_files/analytics.js"></script><script src="Ruby%20Faraday%20tutorial_files/platform.js" async="" defer="defer" gapi_processed="true"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-5536206-1', 'auto');
  ga('send', 'pageview');

</script>

<script type="text/javascript" charset="utf-8" async="" src="Ruby%20Faraday%20tutorial_files/button.js"></script><style type="text/css">.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_reposition{overflow:hidden;position:relative}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}.fb_link img{border:none}@keyframes fb_transform{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}.fb_animate{animation:fb_transform .3s forwards}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}.fb_reset .fb_dialog_legacy{overflow:visible}.fb_dialog_advanced{padding:10px;-moz-border-radius:8px;-webkit-border-radius:8px;border-radius:8px}.fb_dialog_content{background:#fff;color:#333}.fb_dialog_close_icon{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px}.fb_dialog_mobile .fb_dialog_close_icon{top:5px;left:5px;right:auto}.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}.fb_dialog_close_icon:hover{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent}.fb_dialog_close_icon:active{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent}.fb_dialog_loader{background-color:#f6f7f9;border:1px solid #606060;font-size:24px;padding:20px}.fb_dialog_top_left,.fb_dialog_top_right,.fb_dialog_bottom_left,.fb_dialog_bottom_right{height:10px;width:10px;overflow:hidden;position:absolute}.fb_dialog_top_left{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/ye/r/8YeTNIlTZjm.png) no-repeat 0 0;left:-10px;top:-10px}.fb_dialog_top_right{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/ye/r/8YeTNIlTZjm.png) no-repeat 0 -10px;right:-10px;top:-10px}.fb_dialog_bottom_left{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/ye/r/8YeTNIlTZjm.png) no-repeat 0 -20px;bottom:-10px;left:-10px}.fb_dialog_bottom_right{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/ye/r/8YeTNIlTZjm.png) no-repeat 0 -30px;right:-10px;bottom:-10px}.fb_dialog_vert_left,.fb_dialog_vert_right,.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{position:absolute;background:#525252;filter:alpha(opacity=70);opacity:.7}.fb_dialog_vert_left,.fb_dialog_vert_right{width:10px;height:100%}.fb_dialog_vert_left{margin-left:-10px}.fb_dialog_vert_right{right:0;margin-right:-10px}.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{width:100%;height:10px}.fb_dialog_horiz_top{margin-top:-10px}.fb_dialog_horiz_bottom{bottom:0;margin-bottom:-10px}.fb_dialog_iframe{line-height:0}.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #365899;color:#fff;font-size:14px;font-weight:bold;margin:0}.fb_dialog_content .dialog_title>span{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yd/r/Cou7n-nqK52.gif) no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}body.fb_hidden{-webkit-transform:none;height:100%;margin:0;overflow:visible;position:absolute;top:-10000px;left:0;width:100%}.fb_dialog.fb_dialog_mobile.loading{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/ya/r/3rhSv5V8j3o.gif) white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}.fb_dialog.fb_dialog_mobile.loading.centered{width:auto;height:auto;min-height:initial;min-width:initial;background:none}.fb_dialog.fb_dialog_mobile.loading.centered #fb_dialog_loader_spinner{width:100%}.fb_dialog.fb_dialog_mobile.loading.centered .fb_dialog_content{background:none}.loading.centered #fb_dialog_loader_close{color:#fff;display:block;padding-top:20px;clear:both;font-size:18px}#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .45);position:absolute;bottom:0;left:0;right:0;top:0;width:100%;min-height:100%;z-index:10000}#fb-root #fb_dialog_ipad_overlay.hidden{display:none}.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}.fb_dialog_content .dialog_header{-webkit-box-shadow:white 0 1px 1px -1px inset;background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#738ABA), to(#2C4987));border-bottom:1px solid;border-color:#1d4088;color:#fff;font:14px Helvetica, sans-serif;font-weight:bold;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}.fb_dialog_content .dialog_header table{-webkit-font-smoothing:subpixel-antialiased;height:43px;width:100%}.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px}.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px}.fb_dialog_content .touchable_button{background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#4966A6), color-stop(.5, #355492), to(#2A4887));border:1px solid #29487d;-webkit-background-clip:padding-box;-webkit-border-radius:3px;-webkit-box-shadow:rgba(0, 0, 0, .117188) 0 1px 1px inset, rgba(255, 255, 255, .167969) 0 1px 0;display:inline-block;margin-top:3px;max-width:85px;line-height:18px;padding:4px 12px;position:relative}.fb_dialog_content .dialog_header .touchable_button input{border:none;background:none;color:#fff;font:12px Helvetica, sans-serif;font-weight:bold;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}.fb_dialog_content .dialog_content{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #555;border-bottom:0;border-top:0;height:150px}.fb_dialog_content .dialog_footer{background:#f6f7f9;border:1px solid #555;border-top-color:#ccc;height:40px}#fb_dialog_loader_close{float:left}.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}#fb_dialog_loader_spinner{animation:rotateSpinner 1.2s linear infinite;background-color:transparent;background-image:url(https://static.xx.fbcdn.net/rsrc.php/v3/yD/r/t-wz8gw1xG1.png);background-repeat:no-repeat;background-position:50% 50%;height:24px;width:24px}@keyframes rotateSpinner{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.fb_iframe_widget{display:inline-block;position:relative}.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify}.fb_iframe_widget iframe{position:absolute}.fb_iframe_widget_fluid_desktop,.fb_iframe_widget_fluid_desktop span,.fb_iframe_widget_fluid_desktop iframe{max-width:100%}.fb_iframe_widget_fluid_desktop iframe{min-width:220px;position:relative}.fb_iframe_widget_lift{z-index:1}.fb_hide_iframes iframe{position:relative;left:-10000px}.fb_iframe_widget_loader{position:relative;display:inline-block}.fb_iframe_widget_fluid{display:inline}.fb_iframe_widget_fluid span{width:100%}.fb_iframe_widget_loader iframe{min-height:32px;z-index:2;zoom:1}.fb_iframe_widget_loader .FB_Loader{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/y9/r/jKEcVPZFk-2.gif) no-repeat;height:32px;width:32px;margin-left:-16px;position:absolute;left:50%;z-index:4}</style></head>

<body cz-shortcut-listen="true">

<div class="container">

<div id="wide_ad" class="ltow">
<script async="" src="Ruby%20Faraday%20tutorial_files/adsbygoogle.js"></script>
<!-- 160x600, August 2011 -->
<ins class="adsbygoogle" style="display:inline-block;width:160px;height:600px" data-ad-client="ca-pub-9706709751191532" data-ad-slot="2484182563" data-adsbygoogle-status="done"><ins id="aswift_0_expand" style="display:inline-table;border:none;height:600px;margin:0;padding:0;position:relative;visibility:visible;width:160px;background-color:transparent;"><ins id="aswift_0_anchor" style="display:block;border:none;height:600px;margin:0;padding:0;position:relative;visibility:visible;width:160px;background-color:transparent;"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;width:160px;height:600px;" width="160" height="600" frameborder="0"></iframe></ins></ins></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<div class="content">

<header>
 
<nav>
<a href="http://zetcode.com/" title="Home">Home</a>
<a class="nav_r" title="Subscribe to ZetCode news" href="http://zetcode.us13.list-manage.com/subscribe?u=9def9ccd4c70dbbaf691f90fc&amp;id=6556210f80">Subscribe</a>
</nav>

</header>


<h1>Ruby Faraday tutorial</h1>

<p>
In this tutorial, we show how to work with the Ruby Faraday module. We grab data, post
data, work with JSON, and connect to a secure web page. We also create a custom Faraday
middleware. The tutorial uses Sinatra applications for several examples. 
ZetCode has also a concise <a href="http://zetcode.com/lang/rubytutorial/">Ruby tutorial</a>.
</p>

<div class="social">

<div class="fb-like fb_iframe_widget" data-href="http://zetcode.com/web/rubyfaraday/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true" fb-xfbml-state="rendered" fb-iframe-plugin-query="action=like&amp;app_id=&amp;container_width=705&amp;href=http%3A%2F%2Fzetcode.com%2Fweb%2Frubyfaraday%2F&amp;layout=button_count&amp;locale=en_US&amp;sdk=joey&amp;share=true&amp;show_faces=true"><span style="vertical-align: bottom; width: 104px; height: 20px;"><iframe name="f9d784e2e37b24" allowtransparency="true" allowfullscreen="true" scrolling="no" title="fb:like Facebook Social Plugin" style="border: medium none; visibility: visible; width: 104px; height: 20px;" src="Ruby%20Faraday%20tutorial_files/like.html" class="" width="1000px" height="1000px" frameborder="0"></iframe></span></div>

<div style="text-indent: 0px; margin: 0px; padding: 0px; background: transparent none repeat scroll 0% 0%; border-style: none; float: none; line-height: normal; font-size: 1px; vertical-align: baseline; display: inline-block; width: 32px; height: 20px;" id="___plusone_0"><iframe ng-non-bindable="" hspace="0" marginheight="0" marginwidth="0" scrolling="no" style="position: static; top: 0px; width: 32px; margin: 0px; border-style: none; left: 0px; visibility: visible; height: 20px;" tabindex="0" vspace="0" id="I0_1505282883834" name="I0_1505282883834" src="Ruby%20Faraday%20tutorial_files/fastbutton.html" data-gapiattached="true" title="G+" width="100%" frameborder="0"></iframe></div>

<div class="twitter">
<iframe id="twitter-widget-0" scrolling="no" allowtransparency="true" class="twitter-share-button twitter-share-button-rendered twitter-tweet-button" style="position: static; visibility: visible; width: 60px; height: 20px;" title="Twitter Tweet Button" src="Ruby%20Faraday%20tutorial_files/tweet_button.html" frameborder="0"></iframe>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id))
{js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

</div>

<p>
The <dfn>Hypertext Transfer Protocol (<abbr>HTTP</abbr>)</dfn> is an application protocol for distributed, collaborative,
hypermedia information systems. HTTP is the foundation of data communication for the World Wide Web.
</p>

<div class="med_rec">
<script async="" src="Ruby%20Faraday%20tutorial_files/adsbygoogle.js"></script>
<!-- NewSquare -->
<ins class="adsbygoogle" style="display: inline-block; width: 300px; height: 250px;" data-ad-client="ca-pub-9706709751191532" data-ad-slot="0364418177" data-adsbygoogle-status="done"><ins id="aswift_1_expand" style="display:inline-table;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:300px;background-color:transparent;"><ins id="aswift_1_anchor" style="display:block;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:300px;background-color:transparent;"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_1" name="aswift_1" style="left:0;position:absolute;top:0;width:300px;height:250px;" width="300" height="250" frameborder="0"></iframe></ins></ins></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<p>
Ruby <code>Faraday</code> is a simple, flexible HTTP client library, with support for multiple backends.
Faraday also is a middleware.
</p>

<pre>$ sudo gem install faraday
</pre>

<p>
The module is installed with the <code>sudo gem install faraday</code> command.
</p>


<h2>Sinatra</h2>

<p>
<dfn>Sinatra</dfn> is a popular Ruby web application framework. It is easy to install 
and set up. Some of our examples will also use a Sinatra application.
</p>

<pre>$ sudo gem install sinatra
$ sudo gem install thin
</pre>

<p>
We install Sinatra and Thin web server. If Thin is installed, Sinatra 
automatically chooses Thin over the default WEBrick server.
</p>

<pre>$ pwd
/home/janbodnar/prog/sinatra/first
$ ls
main.rb
</pre>

<p>
Inside the first directory, we have a <code>main.rb</code> file, which is the Sinatra
application file.
</p><p>

</p><div class="codehead">main.rb</div>
<pre class="code">require 'sinatra'

get '/' do
    "First application"
end
</pre>

<p>
The application reacts to the <code>/</code> route. It sends a simple message back
to the client.
</p>

<pre>$ ruby main.rb 
== Sinatra (v1.4.7) has taken the stage on 4567 for development with backup from Thin
Thin web server (v1.6.4 codename Gob Bluth)
Maximum connections set to 1024
Listening on localhost:4567, CTRL+C to stop
</pre>

<p>
The application is started with <code>ruby main.rb</code> command. The Thin server
is launched; it listens on 4567 port.
</p>

<pre>$ curl localhost:4567/
First application
</pre>

<p>
With the <code>curl</code> command line tool, we connect to the server and access
the <code>/</code> route. A message appears on the console.
</p>


<h2>Version</h2>

<p>
The first Faraday program prints the version of the library and of the Ruby language.
</p>

<div class="codehead">version.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

puts Faraday::VERSION
puts Faraday::default_adapter
</pre>

<p>
The two constants provide the library version number and the default
Faraday adapter. 
</p>

<pre>$ ./version.rb 
0.9.2
net_http
</pre>

<p>
This is a sample output of the string.
</p>


<h2>Getting content</h2>

<p>
The <code>get</code> method fetches documents identified by the given URL.
</p>

<div class="codehead">get_content.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

res = Faraday.get 'http://www.something.com' 

puts res.body
</pre>

<p>
The script grabs the content of the <code>www.something.com</code> web page.
</p>


<pre>$ ./get_content.rb 
&lt;html&gt;&lt;head&gt;&lt;title&gt;Something.&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;Something.&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>
This is the output of the <code>get_content.rb</code> script.
</p>

<p>
The following program gets a small web page and strips its HTML tags. 
</p>

<div class="codehead">strip_tags.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

con = Faraday::Connection.new "http://www.something.com"

res = con.get

puts res.body.gsub(%r{&lt;/?[^&gt;]+?&gt;}, '')
</pre>

<p>
The script strips the HTML tags of the <code>www.something.com</code>
web page.
</p>

<pre class="explanation">puts res.body.gsub(%r{&lt;/?[^&gt;]+?&gt;}, '')
</pre>

<p>
A simple regular expression is used to strip the HTML tags.
</p>

<pre>$ ./strip_tags.rb 
Something.
Something.
</pre>

<p>
The script prints the web page's title and content.
</p>


<h2>Status</h2>

<p>
The <code>status</code> method of the <code>Faraday::Response</code> returns the 
HTTP status code of the response.
</p>

<div class="codehead">status.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

res = Faraday.get 'http://www.something.com'  
puts res.status
puts res.success?

res = Faraday.get 'http://www.something.com/news/'
puts res.status
puts res.success?

res = Faraday.get 'http://www.urbandicionary.com/define.php?term=Dog'
puts res.status
puts res.success?
</pre>

<p>
We perform three HTTP requests with the <code>get</code> method
and check for returned status.
</p>

<pre class="explanation">res = Faraday.get 'http://www.something.com'  
puts res.status
</pre>

<p>
The status of the HTTP response is checked with the <code>status</code>
method.
</p>

<pre class="explanation">puts res.success?
</pre>

<p>
The <code>success?</code> method tells whether the status code was successful.
</p>

<pre>$ ./status.rb 
200
true
404
false
302
false
</pre>

<p>
200 is a standard response for successful HTTP requests, 404 tells that the requested 
resource could not be found, and 302 tells that the resource was temporarily redirected.
</p>


<h2>The head method</h2>

<p>
The <code>head</code> method retrieves document headers. 
The headers consist of fields, including date, server, content type, 
or last modification time.
</p>

<div class="codehead">head.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

con = Faraday.new :url =&gt; "http://www.something.com"

res = con.head 

puts res.headers['server']
puts res.headers['date']
puts res.headers['last-modified']
puts res.headers['content-type']
puts res.headers['content-length']
</pre>

<p>
The example prints the server, date, last modification time, content type, and content length 
of the <code>www.something.com</code> web page.
</p>

<pre>$ ./head.rb 
Apache/2.4.12 (FreeBSD) OpenSSL/1.0.1l-freebsd mod_fastcgi/mod_fastcgi-SNAP-0910052141
Tue, 10 May 2016 10:19:01 GMT
Mon, 25 Oct 1999 15:36:02 GMT
text/html
77
</pre>

<p>
This is the output of the <code>head.rb</code> program.
</p>


<h2>The get method</h2>

<p>
The <code>get</code> method issues a GET request to the server.
The GET method requests a representation of the specified resource.
</p>

<div class="codehead">main.rb</div>
<pre class="code">require 'sinatra'

get '/greet' do  
    "Hello #{params[:name]}"
end
</pre>

<p>
This is the Sinatra application file. Upon receiving the <code>/greet</code> route, 
it returns a message containing the name which was sent by the client.
</p>

<div class="codehead">mget.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

con = Faraday.new 

res = con.get 'http://localhost:4567/greet', { :name =&gt; 'Peter' }

puts res.body   
</pre>

<p>
The script sends a variable with a value to the Sinatra application. The variable is 
specified directly in the URL.
</p>

<pre>$ ./mget.rb 
Hello Peter
</pre>

<p>
This is the output of the example.
</p>

<pre>127.0.0.1 - - [10/May/2016:22:04:38 +0200] "GET /greet?name=Peter HTTP/1.1" 200 11 0.0034
</pre>

<p>
In this log of the Thin server we can see that the parameter was encoded into the URL.
</p>

<p>
The <code>get</code> method takes a second parameter where
we can specify the query parameters.
</p>

<div class="codehead">mget2.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

res = Faraday.get do |req|
    req.url 'http://localhost/greet' 
    req.params['name']  = 'Jan' 
end

puts res.body  
</pre>

<p>
This is another way of issuing the GET message.
</p>

<pre>$ ./mget2.rb 
Hello Peter
</pre>

<p>
This is the output of the example.
</p>


<h2>User agent</h2>

<p>
In this section, we specify the name of the user agent.
</p>

<div class="codehead">main.rb</div>
<pre class="code">require 'sinatra'

get '/agent' do
    request.user_agent
end
</pre>

<p>
The Sinatra application returns the user agent sent by the client.
</p>

<div class="codehead">agent.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

con = Faraday.new 

res = con.get do |req| 
    req.url 'http://localhost:4567/agent' 
    req.headers['User-Agent'] = 'Ruby script'
end

puts res.body
</pre>

<p>
This script creates a simple GET request to the Sinatra application.
</p>

<pre class="explanation">res = con.get do |req| 
    req.url 'http://localhost:4567/agent' 
    req.headers['User-Agent'] = 'Ruby script'
end
</pre>

<p>
The user agent is specified in the <code>headers</code> attribute
of the request.
</p>

<pre>$ ./agent.rb 
Ruby script
</pre>

<p>
The server responded with the name of the agent that we have sent
with the request.
</p>


<h2>Posting a value</h2>

<p>
The <code>post</code> method dispatches a POST request on the given 
URL, providing the key/value pairs for the fill-in form content.
</p>

<div class="codehead">main.rb</div>
<pre class="code">require 'sinatra'

post '/target' do
    "Hello #{params[:name]}"
end
</pre>

<p>
The Sinatra application returns a greeting on the <code>/target</code>
route. It takes the value from the <code>params</code> hash.
</p>

<div class="codehead">mpost.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

con = Faraday.new 'http://localhost'

res = con.post '/target', { :name =&gt; 'Jan' }

puts res.body
</pre>

<p>
The script sends a request with a <code>name</code> key having <code>Jan</code> value.
The POST request is issued with the <code>post</code> method.
</p>

<pre>$ ./mpost.rb 
Hello Jan
</pre>

<p>
This is the output of the <code>mpost.rb</code> script.
</p>

<pre>127.0.0.1 - - [11/May/2016:13:49:44 +0200] "POST /target HTTP/1.1" 200 9 0.0006
</pre>

<p>
With the POST method, the value is not send in the request URL.
</p>


<h2>Retrieving definitions from a dictionary</h2>

<p>
In the following example, we find definitions of a term
on the <a href="http://www.dictionary.com/">www.dictionary.com</a>. 
To parse HTML, we use the <code>nokogiri</code> gem. It can be 
installed with the <code>sudo gem install nokogiri</code> command.
</p>

<div class="codehead">get_term.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'
require 'nokogiri'

term = 'dog'
con = Faraday.new :url =&gt; 'http://www.dictionary.com/browse/'+term

res = con.get 

doc = Nokogiri::HTML res.body
doc.css("div.def-content").map do |node|
    s = node.text.strip!
    s.gsub!(/\s{3,}/, " ") unless (s == nil)
    puts s unless (s == nil)
end
</pre>

<p>
In this script, we find the definitions of the term dog on <code>www.dictionary.com</code>.
The <code>Nokogiri::HTML</code> is used to parse the HTML code.
</p>

<pre class="explanation">con = Faraday.new :url =&gt; 'http://www.dictionary.com/browse/'+term
</pre>

<p>
To perform a search, we append the term at the end of the URL.
</p>

<pre class="explanation">doc = Nokogiri::HTML res.body
doc.css("div.def-content").map do |node|
    s = node.text.strip!
    s.gsub!(/\s{3,}/, " ") unless (s == nil)
    puts s unless (s == nil)
end
</pre>

<p>
We parse the content with the <code>Nokogiri::HTML</code> class.
The definitions are located inside the <code>&lt;div class="def-content"&gt;</code> tag.
We improve the formatting by removing excessive white space.
</p>


<h2>JSON</h2>

<p>
<dfn><abbr>JSON</abbr></dfn> (JavaScript Object Notation) is a lightweight data-interchange format. 
It is easy for humans to read and write and for machines to parse and generate. 
</p>

<pre>$ sudo gem install json
</pre>

<p>
We have to install <code>json</code> gem if we haven't done so before.
</p>

<div class="codehead">main.rb</div>
<pre class="code">require 'sinatra'
require 'json'

get '/example.json' do
    content_type :json
    { :name =&gt; 'Jane', :age =&gt; 17 }.to_json
end
</pre>

<p>
The Sinatra application sends JSON data. It uses the <code>to_json</code> method 
to do the job.
</p>

<div class="codehead">parse_json.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'
require 'json'
 
con = Faraday.new :url =&gt; 'http://localhost:4567/example.json'
  
res = con.get
data = JSON.parse res.body

puts data["name"]
puts data["age"]
</pre>

<p>
The example reads JSON data sent by the Sinatra application.
</p>

<pre>$ ./parse_json.rb 
Jane
17
</pre>

<p>
This is the output of the example.
</p>

<p>
Next, we send JSON data to a Sinatra application
from a Ruby script.
</p>

<div class="codehead">main.rb</div>
<pre class="code">require 'sinatra'
require 'json'

post '/readjson' do
    data = JSON.parse request.body.read
    puts data
    "#{data["name"]} is #{data["age"]} years old"
end
</pre>

<p>
This application reads JSON data and sends back a message with
the parsed values.
</p>

<div class="codehead">post_json.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

con = Faraday.new 

res = con.post do |req|
    req.url 'http://localhost:4567/readjson'
    req.headers['Content-Type'] = 'application/json'
    req.body = '{ "name": "Jane", "age": 17 }'
end

puts res.body
</pre>

<p>
This script sends JSON data to the Sinatra application and 
reads its response.
</p>

<pre class="explanation">req.headers['Content-Type'] = 'application/json'
</pre>

<p>
The <code>'application/json'</code> content type must be specified
in the request.
</p>

<pre>$ ./post_json.rb 
Jane is 17 years old
</pre>

<p>
This is the output of the example.
</p>


<h2>Credentials</h2>

<p>
The  <code>basic_auth</code> method sets the name and password 
to be used for a realm. A security realm is a mechanism used for protecting 
web application resources.
</p>

<pre>$ sudo gem install sinatra-basic-auth
</pre>

<p>
For this example, we need to install the <code>sinatra-basic-auth</code> gem.
</p>

<div class="codehead">main.rb</div>
<pre class="code">require 'sinatra'
require "sinatra/basic_auth"

authorize do |username, password|
    username == "user7" &amp;&amp; password == "7user"
end

get '/' do
    "hello"
end

protect do
    get "/secure" do
        "This is restricted area"
    end
end
</pre>

<p>
In the Sinatra application, we specify the authorization logic and set a 
protected route.
</p>

<div class="codehead">credentials.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'

con = Faraday.new :url =&gt; 'http://localhost/secure/'

user = 'user7'
passwd = '7user'

con.basic_auth  user, passwd
res = con.get 

puts res.body
</pre>

<p>
The script connects to the secure webpage; it provides the user name
and the password necessary to access the page.
</p>

<pre>$ ./credentials.rb 
This is restricted area
</pre>

<p>
With the right credentials, the <code>credentials.rb</code> script returns 
the restricted data.
</p>


<h2>Faraday middleware</h2>

<p>
<dfn>Middleware</dfn> is a software that connects two otherwise separate applications. 
In addition to being an HTTP client, Faraday also acts as a middleware. The concept
is very similar to Ruby Rack.
</p>

<p>
<code>Faraday::Connection</code> contains a list of middlewares. Faraday middlewares 
are passed an <code>env</code> hash that has request and response information. 
The middlewares can manipulate this information before and after a request is executed.
</p>


<h3>Redirection</h3>

<p>
Redirection is the process of forwarding one URL to a different URL. 
The HTTP response status code 302 is used for temporary URL redirection.
</p>

<p>
Redirection is implemented in one of the Faraday middleware modules.
</p>

<pre>$ sudo gem install faraday_middleware
</pre>

<p>
These modules are available in the <code>faraday_middleware</code> gem.
</p>

<div class="codehead">main.rb</div>
<pre class="code">require 'sinatra'

get "/oldpage" do  
    redirect to("/files/newpage.html"), 302
end
</pre>

<p>
In the Sinatra application, we use the <code>redirect</code> command to redirect
to a different location.
</p>

<div class="codehead">newpage.html</div>
<pre class="code">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;New page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;p&gt;
This is a new page
&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>
This is the <code>newpage.html</code> file located in the <code>public/files</code> subdirectory.
</p>

<div class="codehead">redirect.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'
require 'faraday_middleware'

con = Faraday.new 'http://localhost:4567/oldpage' do |con|
    con.use FaradayMiddleware::FollowRedirects, limit: 5
    con.adapter Faraday.default_adapter
end

res = con.get
puts res.body
</pre>

<p>
This script accesses the old page and follows the redirect. 
</p>

<pre>$ ./redirect.rb 
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;New page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;p&gt;
This is a new page
&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>
This is the output of the example.
</p>

<pre>127.0.0.1 - - [10/May/2016:22:14:16 +0200] "GET /oldpage HTTP/1.1" 302 - 0.0199
127.0.0.1 - - [10/May/2016:22:14:16 +0200] "GET /files/newpage.html HTTP/1.1" 200 113 0.0073
</pre>

<p>
From the log we see that the request was redirected
to a new file name. The communication consists of two GET messages.
</p>

<h3>MyLogger</h3>

<p>
In the following example, we create our own small middleware. It implements request and
response logging.
</p>

<div class="codehead">main.rb</div>
<pre class="code">require 'sinatra'

get '/greet' do  
    "Hello #{params[:name]}"
end
</pre>

<p>
This is a Sinatra application which sends a greeting to the client.
</p>

<div class="codehead">logger.rb</div>
<pre class="code">#!/usr/bin/ruby

require 'faraday'
require 'logger'

class MyLogger
    
    def initialize app
        @app = app
        @logger = Logger.new(STDOUT)
    end

    def call env
        on_request("request", env)
        @app.call(env).on_complete do
            on_response("response", env)
        end
    end

    private
    def on_request phase, env
        @logger.info("#{phase} : #{env.method} - #{env.url}") if env.method and env.url
    end
    
    private
    def on_response phase, env
        @logger.info("#{phase} : #{env.body}") if env.body 
    end    
end

con = Faraday.new(:url =&gt; "http://localhost:4567") do |build|
    build.request :url_encoded
    build.use MyLogger
    build.adapter  Faraday.default_adapter
end

res = con.get "/greet", {'name' =&gt; 'Jan'}
</pre>

<p>
Here we create a middleware that implements logging to the console.
</p>

<pre class="explanation">def call env
    on_request("request", env)
    @app.call(env).on_complete do
        on_response("response", env)
    end
end
</pre>

<p>
A middleware must implement the <code>call</code> method. It executes 
a method for a request and for a response.
</p>

<pre class="explanation">private
def on_request phase, env
    @logger.info("#{phase} : #{env.method} - #{env.url}") if env.method and env.url
end
</pre>

<p>
Upon generation of a request, the <code>on_request</code> method is called.
The method logs the phase, request method, and URL.
</p>

<pre class="explanation">con = Faraday.new(:url =&gt; "http://localhost:4567") do |build|
    build.request :url_encoded
    build.use MyLogger
    build.adapter Faraday.default_adapter
end
</pre>

<p>
The <code>MyLogger</code> middleware is added to the stack with the <code>use</code>
method. When a connection object executes a request, it creates a shared <code>env</code> hash, 
wraps the outer middlewares around each inner middleware, and executes the call method.
</p>

<pre class="explanation">res = con.get "/greet", {'name' =&gt; 'Jan'}
</pre>

<p>
A message is sent to the Sinatra application. The request and the response are logged to
the terminal.
</p>

<pre>$ ./logger.rb 
I, [2016-05-11T14:48:55.700198 #4945]  INFO -- : request : get - http://localhost:4567/greet?name=Jan
I, [2016-05-11T14:48:55.706989 #4945]  INFO -- : response : Hello Jan
</pre>

<p>
This is the output of the example.
</p>


<div class="big_hor">
<script async="" src="Ruby%20Faraday%20tutorial_files/adsbygoogle.js"></script>
<!-- big_horizontal -->
<ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-9706709751191532" data-ad-slot="2904953388" data-adsbygoogle-status="done"><ins id="aswift_2_expand" style="display:inline-table;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent;"><ins id="aswift_2_anchor" style="display:block;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent;"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_2" name="aswift_2" style="left:0;position:absolute;top:0;width:728px;height:90px;" width="728" height="90" frameborder="0"></iframe></ins></ins></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<p>
In this tutorial, we have worked with the Ruby Faraday module. There are similar
<a href="http://zetcode.com/web/rubyhttpclient/">Ruby HTTPClient tutorial</a> and 
<a href="http://zetcode.com/web/rubynethttp/">Ruby Net::HTTP tutorial</a> on ZetCode.
</p>

<footer>

<nav>
<a href="http://zetcode.com/">Home</a> 
<a href="#">Top of Page</a>
</nav>

<div class="signature">
<a href="http://zetcode.com/">ZetCode</a> last modified May 12, 2016  <span class="copyright">© 2007 - 2017 Jan Bodnar</span>
<span>Follow on <a href="https://www.facebook.com/zetcode7/">Facebook</a></span>
</div>

</footer>

</div> <!-- content -->

</div> <!-- container -->

<div id="fb-root" class=" fb_reset"><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="fb_xdm_frame_http" allowtransparency="true" allowfullscreen="true" scrolling="no" id="fb_xdm_frame_http" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" style="border: medium none;" src="http://staticxx.facebook.com/connect/xd_arbiter/r/0sTQzbapM8j.js?version=42#channel=f18938a0147c658&amp;origin=http%3A%2F%2Fzetcode.com" frameborder="0"></iframe><iframe name="fb_xdm_frame_https" allowtransparency="true" allowfullscreen="true" scrolling="no" id="fb_xdm_frame_https" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" style="border: medium none;" src="Ruby%20Faraday%20tutorial_files/0sTQzbapM8j_002.html" frameborder="0"></iframe></div></div><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div></div></div></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.8";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



<iframe name="oauth2relay860168104" id="oauth2relay860168104" src="Ruby%20Faraday%20tutorial_files/postmessageRelay.html" style="width: 1px; height: 1px; position: absolute; top: -100px;" tabindex="-1" aria-hidden="true"></iframe><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" style="display: none;" frameborder="0"></iframe><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" style="display: none;" frameborder="0"></iframe><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" style="display: none;" frameborder="0"></iframe></body></html>